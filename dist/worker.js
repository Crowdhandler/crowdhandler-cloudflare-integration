!function(e){var t={};function n(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(o,s,function(t){return e[t]}.bind(null,s));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);var o={creativeAssetExtensions:["avi","css","csv","eot","gif","ico","jpg","js","json","map","mov","mp4","mpeg","mpg","ogg","ogv","ott","pdf","png","svg","ttf","webmanifest","wmv","woff","woff2","xml"],lottery:function(e){return Math.round(Math.random()*parseInt(e))},parseCookies:function(e){const t={};return e.cookie&&e.cookie.split(";").forEach(e=>{if(e){const n=e.split("=");t[n[0].trim()]=n[1].trim()}}),t},queryStringParse:function(e){const t=new URLSearchParams(e);let n={};for(let e of t)n[e[0]]=e[1];return n}};const s={result:{status:2,token:null,title:null,position:null,live_position:null,promoted:null,urlRedirect:null,onsale:null,message:null,slug:null,priority:null,priorityAvailable:null,logo:null,responseID:null,captchaRequired:null,ttl:null}};var r={processResponse:async function(e){let t,n={};return t=await e,t?(200!==t.status?n.body=s:n.body=await e.json(),n.status=t.status,n.statusText=t.statusText,n.success=t.ok,n):(n.body=s,n.status=null,n.statusText="Communication failure between Cloudflare and the CrowdHandler API occured.",n.success=!1,n)}};async function c(e){const{request:t}=e,n=Date.now(),s=o.creativeAssetExtensions,c=t.url,l=new URL(c),a=l.hostname,i=l.pathname,u=Object.fromEntries(t.headers),d=u["cf-connecting-ip"],p=u["user-agent"],h=/(.*\d+.*)/;let f;try{f=u["accept-language"].split(",")[0]}catch(e){console.log("Failed to find a valid accept-language value"),console.log(e)}const y=new Request(c,{body:t.body,headers:t.headers,method:t.method,redirect:t.redirect});"undefined"!=typeof NO_BYPASS&&y.headers.append("x-ch-no-bypass",NO_BYPASS);let m,g=!0;"undefined"!=typeof FAIL_TRUST&&"false"===FAIL_TRUST&&(g=!1),"undefined"!=typeof SAFETY_NET_SLUG&&(m=SAFETY_NET_SLUG);let w=i.match(/\.(.*)/);if(null!==w&&(w=w[1]),-1!==s.indexOf(w))return console.log("Static file detected. Going straight to origin."),await fetch(y);let b,$=l.search;$&&(b=o.queryStringParse(decodeURIComponent($)));let S,{"ch-code":v,"ch-id":k,"ch-public-key":P}=b||{};v&&"undefined"!==v&&"null"!==v||(v=""),b&&(delete b["ch-code"],delete b["ch-id"],delete b["ch-public-key"]),b&&0!==Object.keys(b).length?(b=Object.keys(b).map(e=>e+"="+b[e]).join("&"),b="?"+b):b=null,S=b?encodeURIComponent(`https://${a}${i}${b}`):encodeURIComponent(`https://${a}${i}`);let _,R=o.parseCookies(u).crowdhandler;_=k||(R||null),!0!==h.test(_)&&(_=null);const T=API_ENDPOINT;let I,O={headers:{"content-type":"application/json","x-api-key":API_KEY},method:void 0};if(_){O.method="GET";try{I=await fetch(`${T}/requests/${_}?url=${S}&agent=${encodeURIComponent(p)}&ip=${encodeURIComponent(d)}&lang=${encodeURIComponent(f)}`,O)}catch(e){console.error(e)}}else{O.body=JSON.stringify({agent:p,ip:d,lang:f,url:c}),O.method="POST";try{I=await fetch(T+"/requests",O)}catch(e){console.error(e)}}const x=r.processResponse,j=await x(I);let A,E,U;switch(!0!==j.success?(console.error(`API response returned a ${j.status} response with error ${j.statusText}`),A=j.body.result,console.log(A)):(A=j.body.result,console.log(A)),1!==A.promoted&&2!==A.status?(E=!0,U=`https://wait.crowdhandler.com/${A.slug}?url=${S}&ch-code=${v}&ch-id=${A.token}&ch-public-key=${API_KEY}`):!0!==g&&1!==A.promoted&&2===A.status?(E=!0,U=m?`https://wait.crowdhandler.com/${m}?url=${S}&ch-code=${v}&ch-id=${_}&ch-public-key=${API_KEY}`:`https://wait.crowdhandler.com?url=${S}&ch-code=${v}&ch-id=${_}&ch-public-key=${API_KEY}`):E=!1,E){case!0:return console.log("redirecting..."),A.token?new Response(null,{status:302,headers:{Location:U,"Set-Cookie":`crowdhandler=${A.token}; path=/; Secure; HttpOnly`}}):new Response(null,{status:302,headers:{Location:U}});case!1:console.log("continue...")}const C=await fetch(y);let L=new Response(C.body,{status:C.status,statusText:C.statusText,headers:C.headers});!0===h.test(A.token)&&L.headers.append("set-cookie",`crowdhandler=${A.token}; path=/; Secure; HttpOnly`),L.headers.append("set-cookie","crowdhandler_integration=cloudflare; path=/; Secure");const N=Date.now(),Y=A.responseID;return e.waitUntil(new Promise(e=>{e(async function(){if(Y&&0===o.lottery(2)){O.body=JSON.stringify({httpCode:C.status,sampleRate:3,time:N-n}),O.method="PUT",I=await fetch(`${T}/responses/${Y}`,O);const e=r.processResponse;return await e(I)}}())})),L}addEventListener("fetch",e=>{e.respondWith(c(e))})}]);