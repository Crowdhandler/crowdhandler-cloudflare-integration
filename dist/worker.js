!function(e){var t={};function n(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(s,o,function(t){return e[t]}.bind(null,o));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){const{promiseFinally:s,toError:o}=n(1);e.exports=class e{static set(t,n){return(new e).set(t,n)}static wrap(t,n,s){return(new e).wrap(t,n,s)}constructor(){this._id=null,this._delay=null}get id(){return this._id}get delay(){return this._delay}set(e,t=""){return new Promise((n,s)=>{this.clear();const r=t?()=>s(o(t)):n;this._id=setTimeout(r,e),this._delay=e})}wrap(e,t,n=""){const o=s(e,()=>this.clear()),r=this.set(t,n);return Promise.race([o,r])}clear(){this._id&&clearTimeout(this._id)}}},function(e,t){t.promiseFinally=(e,t)=>Promise.resolve(e).then(e=>(t(),e),e=>(t(),Promise.reject(e))),t.toError=e=>"string"==typeof(e="function"==typeof e?e():e)?new Error(e):e},function(e,t,n){"use strict";n.r(t);var s={creativeAssetExtensions:["avi","css","csv","eot","gif","ico","jpg","js","json","map","mov","mp4","mpeg","mpg","ogg","ogv","ott","pdf","png","svg","ttf","webmanifest","wmv","woff","woff2","xml"],wordpressExclusions:/(wp-.*|wc-.*|xmlrpc\.php|readme\.html|license\.txt|trackback|feed(?:\/.*)?|comments\/feed(?:\/.*)?)(\?.*)?/,noCacheHeaders:{"Cache-Control":"no-cache, no-store, must-revalidate",Expires:"Fri, 01 Jan 1970 00:00:00 GMT",Pragma:"no-cache"},lottery:function(e){return Math.round(Math.random()*parseInt(e))},parseCookies:function(e){const t={};return e.cookie&&e.cookie.split(";").forEach(e=>{if(e){const n=e.split("=");t[n[0].trim()]=n[1].trim()}}),t},queryStringParse:function(e){const t=new URLSearchParams(e);let n={};for(let e of t)n[e[0]]=e[1];return n}};const o={result:{status:2,token:null,title:null,position:null,live_position:null,promoted:null,urlRedirect:null,onsale:null,message:null,slug:null,priority:null,priorityAvailable:null,logo:null,responseID:null,captchaRequired:null,ttl:null}};var r={processResponse:async function(e){let t,n={};return t=await e,t?(200!==t.status?n.body=o:n.body=await e.json(),n.status=t.status,n.statusText=t.statusText,n.success=t.ok,n):(n.body=o,n.status=null,n.statusText="Communication failure between Cloudflare and the CrowdHandler API occured.",n.success=!1,n)}};const a=n(0);async function c(e){const{request:t}=e,n=Date.now(),o=s.creativeAssetExtensions,c=s.wordpressExclusions,l=t.url,i=new URL(l),u=i.hostname,d=i.pathname,h=Object.fromEntries(t.headers),p=i.search,f=h["cf-connecting-ip"],m=h["user-agent"],y=/(.*\d+.*)/;let g,w;if(console.log(i),!0===/^\/ch\/.*/.test(d)){const e=await async function(e){let t,n,s="/"+e.queryString,o=e.path.substring(4);t=["dba793b5eb837611498d0b809aefdefcb6f113310b272f6114435964670125a1","04a39378b6abc3e3ee870828471636a9d1e157b1a7720821aed4c260108ebe43"].includes(API_KEY)?"wait-dev.crowdhandler.com":"wait.crowdhandler.com",n=o?`https://${t}/${o}`:`https://${t}${s}`;let r=await caches.open("crowdhandler:cache"),c=await r.match(n);if(c)return console.log("Serving waiting room template from cache."),{response:c,useCache:!0};let l,i,u,d={headers:{"content-type":"text/html;charset=UTF-8"},method:"GET"},h=0,p=await async function e(){let t,s=new a;l=null;try{if(h++,t=await Promise.race([fetch(n,d),s.set(6e3,"API Communication Timed Out!")]),200!==t.status)throw`${t.status} ${t.statusText}`}catch(e){l=!0,console.error("Template Fetch Failure"),console.log(e)}finally{return s.clear(),!0===l&&h<3&&(console.log("Retrying Template Fetch."),await e()),t}}();return p?(i=await async function(e){const{headers:t}=e,n=t.get("content-type")||"";return n.includes("application/json")?JSON.stringify(await e.json()):(n.includes("application/text")||n.includes("text/html"),e.text())}(p),u={headers:{"content-type":"text/html;charset=UTF-8"},status:p.status,statusText:p.statusText}):(i="<h2>Service Temporarily Unavailable</h2>",u={headers:{"content-type":"text/html;charset=UTF-8"},status:503,statusText:"Service Unavailable"}),{cache:r,results:i,resultsMeta:u,templateEndpoint:n}}({path:d,queryString:p});try{if(!0===e.useCache)return e.response}catch(e){console.log(e)}try{e.resultsMeta.headers["cache-control"]="public, max-age=60",200===e.resultsMeta.status&&(console.log("Storing template in cache"),await e.cache.put(e.templateEndpoint,new Response(e.results,e.resultsMeta)))}catch(e){console.log(e)}return new Response(e.results,e.resultsMeta)}try{g=h["accept-language"].split(",")[0]}catch(e){console.log("Failed to find a valid accept-language value"),console.log(e)}const b=new Request(l,{body:t.body,headers:t.headers,method:t.method,redirect:t.redirect});"undefined"!=typeof NO_BYPASS&&b.headers.append("x-ch-no-bypass",NO_BYPASS);let $,T=!0;"undefined"!=typeof FAIL_TRUST&&"false"===FAIL_TRUST&&(T=!1),"undefined"!=typeof SAFETY_NET_SLUG&&($=SAFETY_NET_SLUG);let x=!1;"undefined"!=typeof WHITELABEL&&"true"===WHITELABEL&&(x=!0),w=!0===x?u+"/ch":"wait.crowdhandler.com";let S,v=d.match(/\.(.*)/);if(null!==v&&(v=v[1]),-1!==o.indexOf(v))return console.log("Static file detected. Going straight to origin."),await fetch(b);p&&(S=s.queryStringParse(decodeURIComponent(p)));let _,E,{"ch-code":P,"ch-fresh":I,"ch-id":O,"ch-id-signature":R,"ch-public-key":k,"ch-requested":C}=S||{};if(P&&"undefined"!==P&&"null"!==P||(P=""),S&&(delete S["ch-code"],delete S["ch-fresh"],delete S["ch-id"],delete S["ch-id-signature"],delete S["ch-public-key"],delete S["ch-requested"]),S&&0!==Object.keys(S).length?(S=Object.keys(S).map(e=>e+"="+S[e]).join("&"),S="?"+S):S=null,"undefined"!=typeof ORIGIN_TYPE&&(_=ORIGIN_TYPE),"wordpress"===_&&(!0===c.test(d)||!0===c.test(S)))return console.log("Wordpress exclusion detected. Going straight to origin."),await fetch(b);E=S?encodeURIComponent(`https://${u}${d}${S}`):encodeURIComponent(`https://${u}${d}`);let j,A,U=s.parseCookies(h).crowdhandler;if(O?(j=O,A=!0):j=U||null,A){let e,t={"Set-Cookie":`crowdhandler=${j}; path=/; Secure; HttpOnly`};return e=S?{Location:`${d}${S}`}:{Location:d},new Response(null,{status:302,headers:Object.assign(s.noCacheHeaders,e,t)})}!0!==y.test(j)&&(j=null);const L=API_ENDPOINT;let F,M={headers:{"content-type":"application/json","x-api-key":API_KEY},method:void 0};if(j){M.method="GET";try{F=await fetch(`${L}/requests/${j}?url=${E}&agent=${encodeURIComponent(m)}&ip=${encodeURIComponent(f)}&lang=${encodeURIComponent(g)}`,M)}catch(e){console.error(e)}}else{M.body=JSON.stringify({agent:m,ip:f,lang:g,url:l}),M.method="POST";try{F=await fetch(L+"/requests",M)}catch(e){console.error(e)}}const q=r.processResponse,N=await q(F);let Y,H,G;switch(!0!==N.success?(console.error(`API response returned a ${N.status} response with error ${N.statusText}`),Y=N.body.result,console.log(Y)):(Y=N.body.result,console.log(Y)),1!==Y.promoted&&2!==Y.status?(H=!0,G=`https://${w}/${Y.slug}?url=${E}&ch-code=${P}&ch-id=${Y.token}&ch-public-key=${API_KEY}`):!0!==T&&1!==Y.promoted&&2===Y.status?(H=!0,G=$?`https://${w}/${$}?url=${E}&ch-code=${P}&ch-id=${j}&ch-public-key=${API_KEY}`:`https://${w}/?url=${E}&ch-code=${P}&ch-id=${j}&ch-public-key=${API_KEY}`):H=!1,H){case!0:return console.log("redirecting..."),Y.token?new Response(null,{status:302,headers:Object.assign(s.noCacheHeaders,{Location:G,"Set-Cookie":`crowdhandler=${Y.token}; path=/; Secure; HttpOnly`})}):new Response(null,{status:302,headers:Object.assign(s.noCacheHeaders,{Location:G})});case!1:console.log("continue...")}const D=await fetch(b);let K=new Response(D.body,{status:D.status,statusText:D.statusText,headers:D.headers});!0===y.test(Y.token)&&K.headers.append("set-cookie",`crowdhandler=${Y.token}; path=/; Secure; HttpOnly`),K.headers.append("set-cookie","crowdhandler_integration=cloudflare; path=/; Secure");const B=Date.now(),J=Y.responseID;return e.waitUntil(new Promise(e=>{e(async function(){if(J&&0===s.lottery(2)){M.body=JSON.stringify({httpCode:D.status,sampleRate:3,time:B-n}),M.method="PUT",F=await fetch(`${L}/responses/${J}`,M);const e=r.processResponse;return await e(F)}}())})),K}addEventListener("fetch",e=>{e.respondWith(c(e))})}]);